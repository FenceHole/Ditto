<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ditto | The Sovereign Court</title>
    <!-- Sovereign Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase - Core logic for Chris & Annie's Connection -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900&family=Inter:wght@300;400;700&display=swap');
        
        :root {
            --court-black: #050507;
            --court-crimson: #7f1d1d;
            --court-gold: #d4af37;
        }

        body { 
            font-family: 'Playfair Display', serif; 
            background-color: var(--court-black); 
            color: #e2e8f0; 
            overflow-x: hidden; 
        }

        .font-sans { font-family: 'Inter', sans-serif; }
        
        .glass { 
            background: rgba(255, 255, 255, 0.02); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        .court-gradient { 
            background: radial-gradient(circle at center, #2d0606 0%, #050507 100%); 
        }

        .gold-glow {
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .crimson-shadow {
            box-shadow: 0 10px 30px -10px rgba(127, 29, 29, 0.5);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--court-crimson); border-radius: 10px; }

        input::placeholder { opacity: 0.2; }
        
        @keyframes pulse-gold {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .animate-gold { animation: pulse-gold 3s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        if (firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth?.();
        const db = firebase.firestore?.();
        const appId = 'ditto-ultimate-sanctuary';

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if(window.lucide) lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [sanctuaryId, setSanctuaryId] = useState(() => 
                localStorage.getItem('sanctuaryId') || ''
            );
            const [user, setUser] = useState(null);
            const [artifacts, setArtifacts] = useState([]);
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (sanctuaryId) {
                    localStorage.setItem('sanctuaryId', sanctuaryId);
                }
            }, [sanctuaryId]);

            // FIREBASE AUTH
            useEffect(() => {
                if (!auth) {
                    setLoading(false);
                    return;
                }
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                    } else {
                        try {
                            const userCredential = await auth.signInAnonymously();
                            setUser(userCredential.user);
                        } catch (error) {
                            console.error('Auth error:', error);
                        }
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // FIRESTORE SUBSCRIPTION
            useEffect(() => {
                if (!db || !sanctuaryId || !user) return;
                const collectionPath = `artifacts/${appId}/public/data/court_${sanctuaryId}`;
                const unsubscribe = db.collection(collectionPath)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setArtifacts(docs);
                    }, (error) => {
                        console.error('Firestore error:', error);
                    });
                return () => unsubscribe();
            }, [sanctuaryId, user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!message.trim() || !sanctuaryId || !db || !user) return;

                const collectionPath = `artifacts/${appId}/public/data/court_${sanctuaryId}`;
                try {
                    await db.collection(collectionPath).add({
                        message: message.trim(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: user.uid
                    });
                    setMessage('');
                } catch (error) {
                    console.error('Error submitting:', error);
                }
            };

            const formatDate = (timestamp) => {
                if (!timestamp) return 'Just now';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString();
            };

            if (loading) {
                return (
                    <div className="min-h-screen court-gradient flex items-center justify-center">
                        <div className="text-2xl gold-glow">Loading...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen court-gradient p-8">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-12">
                            <h1 className="text-6xl font-bold mb-4 gold-glow" style={{ color: 'var(--court-gold)' }}>
                                The Sovereign Court
                            </h1>
                            <p className="text-xl opacity-70">Chris & Annie's Eternal Connection</p>
                        </div>

                        {/* Sanctuary ID Input */}
                        {!sanctuaryId && (
                            <div className="glass p-8 rounded-2xl mb-8 crimson-shadow">
                                <h2 className="text-2xl mb-4 font-sans">Enter Sanctuary ID</h2>
                                <input
                                    type="text"
                                    value={sanctuaryId}
                                    onChange={(e) => setSanctuaryId(e.target.value)}
                                    placeholder="sanctuary-id"
                                    className="w-full bg-transparent border border-gray-700 rounded-lg px-4 py-3 text-lg focus:outline-none focus:border-amber-700"
                                />
                            </div>
                        )}

                        {sanctuaryId && (
                            <>
                                {/* Submit Form */}
                                <div className="glass p-8 rounded-2xl mb-8 crimson-shadow">
                                    <h2 className="text-2xl mb-4 font-sans flex items-center gap-2">
                                        <Icon name="feather" size={24} className="animate-gold" style={{ color: 'var(--court-gold)' }} />
                                        Record Your Thought
                                    </h2>
                                    <form onSubmit={handleSubmit}>
                                        <textarea
                                            value={message}
                                            onChange={(e) => setMessage(e.target.value)}
                                            placeholder="What wisdom do you wish to inscribe?"
                                            className="w-full bg-transparent border border-gray-700 rounded-lg px-4 py-3 text-lg focus:outline-none focus:border-amber-700 min-h-[120px] custom-scrollbar"
                                            style={{ resize: 'vertical' }}
                                        />
                                        <button
                                            type="submit"
                                            disabled={!message.trim()}
                                            className="mt-4 px-8 py-3 rounded-lg font-sans font-bold transition-all disabled:opacity-30"
                                            style={{
                                                backgroundColor: 'var(--court-crimson)',
                                                color: 'var(--court-gold)'
                                            }}
                                        >
                                            Submit to the Court
                                        </button>
                                    </form>
                                    <div className="mt-4 text-sm opacity-50">
                                        Sanctuary: <span className="font-mono">{sanctuaryId}</span>
                                        {' | '}
                                        <button
                                            onClick={() => {
                                                localStorage.removeItem('sanctuaryId');
                                                setSanctuaryId('');
                                            }}
                                            className="underline hover:opacity-100"
                                        >
                                            Change
                                        </button>
                                    </div>
                                </div>

                                {/* Artifacts List */}
                                <div className="glass p-8 rounded-2xl crimson-shadow">
                                    <h2 className="text-2xl mb-6 font-sans flex items-center gap-2">
                                        <Icon name="scroll" size={24} style={{ color: 'var(--court-gold)' }} />
                                        Court Records ({artifacts.length})
                                    </h2>
                                    <div className="space-y-4 custom-scrollbar" style={{ maxHeight: '500px', overflowY: 'auto' }}>
                                        {artifacts.length === 0 ? (
                                            <p className="text-center opacity-50 py-8">No records yet. Be the first to inscribe.</p>
                                        ) : (
                                            artifacts.map((artifact) => (
                                                <div
                                                    key={artifact.id}
                                                    className="bg-black bg-opacity-30 p-4 rounded-lg border border-gray-800"
                                                >
                                                    <p className="text-lg mb-2">{artifact.message}</p>
                                                    <p className="text-xs opacity-40 font-sans">
                                                        {formatDate(artifact.timestamp)}
                                                    </p>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </>
                        )}

                        {/* Footer */}
                        <div className="text-center mt-12 opacity-30 text-sm">
                            <p>Powered by Firebase & React | A Sovereign Sanctuary</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
