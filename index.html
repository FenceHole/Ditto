<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ditto</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#080404; color:#fff; }
    .container{max-width:900px;margin:48px auto;padding:24px}
    .card{background:#0b0b0b;padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,0.04)}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:12px;background:#000;border:1px solid rgba(255,255,255,0.06);color:#fff}
    button{padding:10px 16px;border-radius:12px;background:#c02626;border:none;color:#fff;cursor:pointer}
    input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .entry{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
    code { background: rgba(255,255,255,0.03); padding:2px 6px; border-radius:4px; font-size:90%; }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <!-- Optional: projects can set window.__firebase_config before the app script to initialize Firebase.
       Example (do NOT commit real secrets into the repo):
  <script>
    window.__firebase_config = JSON.stringify({
      apiKey: "YOUR_API_KEY",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project-id",
      // ...other firebase config
    });
  </script>
  
  -->

  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // App ID used in the original repo; keep consistent with collection paths
    const appId = 'ditto_court_v3';

    // Read optional firebase config provided via window.__firebase_config
    const firebaseConfig = (() => {
      try {
        return JSON.parse(window.__firebase_config || '{}');
      } catch (e) {
        console.warn('Failed to parse window.__firebase_config', e);
        return {};
      }
    })();

    if (firebaseConfig.apiKey) {
      try { firebase.initializeApp(firebaseConfig); } catch(e) { console.warn('firebase init', e); }
    }

    const auth = window.firebase?.auth?.();
    const db = window.firebase?.firestore?.();

    function App(){
      const [view, setView] = useState('setup');
      const [user, setUser] = useState(null);
      const [sanctuaryId, setSanctuaryId] = useState('');
      const [inputKey, setInputKey] = useState('');
      const [answer, setAnswer] = useState('');
      const [entries, setEntries] = useState([]);

      // On mount: restore saved key and sign in anonymously
      useEffect(()=>{
        const savedKey = localStorage.getItem('ditto_court_v3_id');
        if (savedKey){ setSanctuaryId(savedKey); setView('bench'); }

        if (auth && auth.signInAnonymously){
          auth.signInAnonymously().catch(console.error);
          const unsub = auth.onAuthStateChanged(u=>setUser(u));
          return () => unsub?.();
        }
      },[]);

      // Firestore listener for entries in the sanctuary collection
      useEffect(()=>{
        if (!user || !sanctuaryId || !db) return;
        const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`court_${sanctuaryId}`);
        const unsub = ref.orderBy('timestamp','desc').onSnapshot(snap => {
          const data = snap.docs.map(d=>({id:d.id, ...d.data()}));
          setEntries(data);
        }, err => console.error('firestore listen error', err));
        return () => unsub();
      }, [user, sanctuaryId]);

      const submitEcho = async(cat='daily') => {
        if (!answer.trim()) return;
        if (!db || !user) {
          alert('Database or user not available. Make sure firebase config is set.');
          return;
        }
        const isChris = user.uid === entries.find(e => e.userName === 'Chris')?.uid || entries.length === 0;
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`court_${sanctuaryId}`).add({
          uid: user.uid,
          userName: isChris ? 'Chris' : 'Annie',
          content: answer,
          category: cat,
          prompt: 'user submitted',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        setAnswer('');
        if (cat === 'bench') setView('echoes');
      };

      if (view === 'setup'){
        return (
          <div className="card">
            <h2>Welcome to Ditto</h2>
            <p>Enter a 6-character court key or create one</p>
            <div style={{display:'flex',gap:8,marginTop:12}}>
              <input value={inputKey} onChange={e=>setInputKey(e.target.value.toUpperCase())} placeholder="KEY" />
              <button onClick={()=>{ if (inputKey.length===6){ setSanctuaryId(inputKey.toUpperCase()); localStorage.setItem('ditto_court_v3_id', inputKey.toUpperCase()); setView('bench'); }}}>Connect Hearts</button>
            </div>

            <div style={{marginTop:16}}>
              <button onClick={()=>{ const key = Math.random().toString(36).substring(2,8).toUpperCase(); setSanctuaryId(key); localStorage.setItem('ditto_court_v3_id', key); setView('bench'); }}>Establish Our Court</button>
            </div>

            <div style={{marginTop:18}}>
              <p style={{opacity:0.6,fontSize:13}}>CURRENT KEY: {sanctuaryId || '(none)'}</p>
            </div>

            <div style={{marginTop:18}}>
              <p style={{opacity:0.6,fontSize:13}}>To use realtime features you must provide Firebase config via <code>window.__firebase_config</code>.</p>
            </div>
          </div>
        );
      }

      // Bench / main view
      return (
        <div>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
            <h1>Ditto.</h1>
            <div>COURT KEY: {sanctuaryId}</div>
          </div>

          <div className="card">
            <h3>Make a Vow</h3>
            <textarea value={answer} onChange={e=>setAnswer(e.target.value)} placeholder="Unleash the shadows..." />
            <div style={{marginTop:12,display:'flex',gap:8}}>
              <button onClick={()=>submitEcho('bench')}>Ditto This Vow</button>
              <button onClick={()=>{ setView('setup'); localStorage.removeItem('ditto_court_v3_id'); setSanctuaryId(''); }}>Leave Court</button>
            </div>
          </div>

          <div className="card" style={{marginTop:16}}>
            <h3>The Archive of Us</h3>
            {entries.length===0 ? <p>No entries yet.</p> : entries.map(e=> (
              <div key={e.id} className="entry">
                <strong>{e.userName}</strong> <span style={{opacity:0.6,fontSize:12}}>{e.timestamp?.toDate ? e.timestamp.toDate().toLocaleString() : ''}</span>
                <div style={{marginTop:6}}>{e.content}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
